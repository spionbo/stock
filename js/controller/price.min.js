define(["views/draw-stock","modules/stockData"],function(h,c){var g=document,b=Math.round,d=Math.ceil,f=Math.floor,a=Math.abs,e=function(j,k){if(typeof j=="string"){return j}return parseFloat(j).toFixed(k||2)};cache={},Tool={move_draw_top:function(q,s,o,u){var k=q.arr,v=q.len,t=[],n=q.lw,m,w,r,l=1000/60,x=1,p=0,y;if(v>50&&u!=0){x=5}else{x=1}for(;p<x;p++){y=k[u];if(y){s.cr(0,0,C.w,C.h);m=b(u*n)+2.5;r=y[q.n];w=b(C.scale(r))-2.5;if(u!=0){s.l(m,w)}else{s.b().m(m,w).lw(1)}s.s(o);u++}}if(y){requestAnimationFrame(function(){try{C.move_draw_top(q,s,o,u)}catch(j){}})}},move_draw_footer:function(s,t,q,v,u){var m=s.lw,o,x,k=C.canvasBottomHeight,l=s.n,p=C.gray,y=C.key!="timePlan"?cache.dk.w/2:0,z=1,r=0,A;if(s.arr.length>100&&u!=0){z=5}else{z=1}for(;r<z;r++){A=s.arr[u];if(A){o=b(u*m)+2.5+y;x=b(k-C.get_ft_h(parseFloat(A[l]),s.max));if(v!=undefined){p=parseFloat(A[v])>0?C.red:C.green}t.b().m(o,k).l(o,x).lw(q).s(p);u++}}if(A){requestAnimationFrame(function(){try{C.move_draw_footer(s,t,q,v,u)}catch(j){}})}},move_draw_kline:function(r,p,n){var y,D,E,t,q,j,x,B=r.len,A=r.max,v=r.min,m=r.lw,u,q=r.w,o=d(q/2),z,F=2.5;if(r.arr[n]){x=b(n*m)+F;z=parseFloat(r.arr[n][9])>0?C.red:C.green;y=d(C.scale(r.arr[n][1]))-F;t=d(C.scale(r.arr[n][2]))-F-0.5;D=d(C.scale(r.arr[n][3]))-F+0.5;E=d(C.scale(r.arr[n][4]))-F+0.5;p.sv().b().tl(o,0).m(x,D).l(x,E).lw(0.9).s(z).rs().sv().b().f(z).fr(x+0.5,y+0.5,q,b(t-y)).rs();n++;requestAnimationFrame(function(){try{C.move_draw_kline(r,p,n)}catch(k){}})}},move_draw_ma:function(n,o,p,k,q,m){var j=n.arr,l,s;if(p[q]){o.cr(0,0,C.w,C.h);l=b(q*k)+2.5;s=b(C.scale(p[q]))-2.5;try{if(q!=0){o.l(l,s)}else{o.b().m(l,s).lw(1)}q++;o.s(m)}catch(r){console.log("没有找到该MA点")}requestAnimationFrame(function(){try{C.move_draw_ma(n,o,p,k,q,m)}catch(t){}})}}},G={init:function(j,k){G.parentElement=k.options;G.Dome=$(h);G.parentElement.append(G.Dome);G.wapper=j.wapper;G.parent=j;G.setElement();C.init();G.tabEvent();G.animation()},resizeTime:0,resize:function(j){G.width=j.width;G.height=j.height;G.updateCanvas();clearTimeout(G.resizeTime);G.resizeTime=setTimeout(C.resize,300)},updateCanvas:function(){var l=G.width,k=G.height,m=G.element.canvasBox.box,j=4,o=parseInt(G.element.canvasBox.canvas.ptime.elem.css("margin-right")),n=G.element.stockNav.cur;m.width(l*j+o*j+999);n.css3({transform:"translate3d("+(l/G.element.stockNav.li.length*C.site)+"px,0,0)"})},tabEvent:function(){var p=G.element.stockNav.li,o=G.element.stockNav.cur,l=G.element.canvasBox.canvas,m=0,k=0;for(key in l){var m=-k*110,n=-k*56;l[key].elem.css3({transform:"translate3d(0px,0px, "+m+"px) rotateY("+n+"deg)"});k++}o.css({width:100/p.length+"%"});p.each(function(j){this.onclick=function(){var q=G.width/p.length;if(this.className.indexOf("current")>-1){G.currentCanvasTab=true}else{G.currentCanvasTab=false}p.removeClass("current");$(this).addClass("current");m=q*j;o.css3({transform:"translate3d("+m+"px,0,0)"});G.canvasTab(j)}})},currentCanvasTab:false,canvasTab:function(n){var q=G.element,m=q.canvasBox.box,j=q.canvasBox.canvas,r=q.line.elem,p=q.ma.elem,l=q.time.elem,o=q.top.elem,k=-q.canvasBox.elem.width()*n;if(!G.currentCanvasTab){C.clearCanvas(n);r.css3({opacity:0,transform:"translateY(-100px)"});l.css3({opacity:0});p.css3({opacity:0,transform:"translateY(50px)"});o.css3({opacity:0,transform:"scaleY(.5) rotateX(100deg)"});setTimeout(function(){C.resize(n);var s=0;for(i in j){var t=((n-s)*110),u=((n-s)*56);j[i].elem.css3({transform:"translate3d(0px,0px, "+t+"px) rotateY("+u+"deg)"});s++}setTimeout(function(){r.css3({opacity:1,transform:"translateY(0)"});o.css3({opacity:1,transform:"scaleY(1) rotateX(0deg)"});setTimeout(function(){l.css3({opacity:1});n&&p.css3({opacity:1,transform:"translateY(0)"})},510)},310)},310)}},animation:function(){setTimeout(function(){var m=G.element,l=m.canvasBox.box,o=m.time.elem,j=m.line.elem,k=m.stockNav.elem,n=m.top.elem;setTimeout(function(){k.css3({opacity:1,transform:"translateY(0)"});l.css3({transform:"translateX(0)"});setTimeout(function(){n.css3({opacity:1,transform:"scaleY(1) rotateX(0deg)"});j.css3({opacity:1,transform:"translateY(0)"});o.css3({opacity:1,transform:"translateY(0)"})},510)},300)},300)},setElement:function(){var m=G.Dome,o=m.find(".stock-data"),p=m.find(".stock-ma"),k=m.find(".stock-menu"),n=m.find(".stock-time"),j=m.find(".stock-line"),l=m.find(".stock-pic");G.element={elem:m,top:{elem:o,li:o.find("li"),h3:o.find("h3")},ma:{elem:p,li:p.find("li")},stockNav:{elem:k,li:k.find("li"),cur:k.find(".currentLine")},time:{elem:n,li:n.find("li")},line:{elem:j,h_line:{elem:j.find(".hline"),line:j.find(".hline .line"),lnum:j.find(".hline .l_num"),rnum:j.find(".hline .r_num")},v_line:{elem:j.find(".vline"),line:j.find(".vline .line"),num:j.find(".vline .num")},left:{elem:j.find(".left"),li:j.find(".left li")},right:{elem:j.find(".right"),li:j.find(".right li")}},canvasBox:{elem:l,box:l.find(".canvasbox"),canvas:{ptime:{elem:l.find(".minute-canvas"),top:{box:T.canvas(l.find(".minute-canvas .top-pic .draw"),0,0),av:T.canvas(l.find(".minute-canvas .top-pic .av"),0,0),bg:T.canvas(l.find(".minute-canvas .top-pic .bg"),0,0)},bottom:{box:T.canvas(l.find(".minute-canvas .bottom-pic .draw"),0,0),bg:T.canvas(l.find(".minute-canvas .bottom-pic .bg"),0,0)}},day:{elem:l.find(".day-canvas"),top:{box:T.canvas(l.find(".day-canvas .top-pic .draw"),0,0),ma5:T.canvas(l.find(".day-canvas .top-pic .ma5"),0,0),ma10:T.canvas(l.find(".day-canvas .top-pic .ma10"),0,0),ma20:T.canvas(l.find(".day-canvas .top-pic .ma20"),0,0),bg:T.canvas(l.find(".day-canvas .top-pic .bg"),0,0)},bottom:{box:T.canvas(l.find(".day-canvas .bottom-pic .draw"),0,0),bg:T.canvas(l.find(".day-canvas .bottom-pic .bg"),0,0)}},week:{elem:l.find(".week-canvas"),top:{box:T.canvas(l.find(".week-canvas .top-pic .draw"),0,0),ma5:T.canvas(l.find(".week-canvas .top-pic .ma5"),0,0),ma10:T.canvas(l.find(".week-canvas .top-pic .ma10"),0,0),ma20:T.canvas(l.find(".week-canvas .top-pic .ma20"),0,0),bg:T.canvas(l.find(".week-canvas .top-pic .bg"),0,0)},bottom:{box:T.canvas(l.find(".week-canvas .bottom-pic .draw"),0,0),bg:T.canvas(l.find(".week-canvas .bottom-pic .bg"),0,0)}},month:{elem:l.find(".month-canvas"),top:{box:T.canvas(l.find(".month-canvas .top-pic .draw"),0,0),ma5:T.canvas(l.find(".month-canvas .top-pic .ma5"),0,0),ma10:T.canvas(l.find(".month-canvas .top-pic .ma10"),0,0),ma20:T.canvas(l.find(".month-canvas .top-pic .ma20"),0,0),bg:T.canvas(l.find(".month-canvas .top-pic .bg"),0,0)},bottom:{box:T.canvas(l.find(".month-canvas .bottom-pic .draw"),0,0),bg:T.canvas(l.find(".month-canvas .bottom-pic .bg"),0,0)}}}}}}},C={red:"#fa0000",green:"#04ad3a",gray:"#777777",blue:"#005dd8",purple:"#ef00ff",yellow:"#f39900",line_w:242,site:0,canvasName:[],canvas:{},add:function(){T.myAddListener(C.pic,"mousedown",C.down);T.myAddListener(C.pic,"mousemove",C.move);T.myAddListener(C.pic,"mouseup",C.up)},init:function(){var k=G.element,j,l=G.wapper;C.head=k.top.li;C.pic=k.canvasBox.elem;C.MA=k.ma.li;C.footer_time=k.time.li;C.add();C.marginLeft=l[0].offsetLeft+C.pic[0].offsetLeft+parseInt(l.css("border")||0)*2;for(j in k.canvasBox.canvas){C.canvas[j]=k.canvasBox.canvas[j];C.canvasName.push(j)}T.myAddListener(k.elem,"mousedown",C.add);C.l_line=k.line.left.elem;C.l_line.li=k.line.left.li;C.r_line=k.line.right.elem;C.r_line.li=k.line.right.li;C.h_line=k.line.h_line.elem;C.h_line.line=k.line.h_line.line;C.h_line.lnum=k.line.h_line.lnum;C.h_line.rnum=k.line.h_line.rnum;C.v_line=k.line.v_line.elem;C.v_line.line=k.line.v_line.line;C.v_line.num=k.line.v_line.num},resize:function(j){C.site=void 0==j?C.site:j;var l=G.element,k=l.canvasBox.box,n=parseInt(l.canvasBox.canvas.ptime.elem.css("margin-right")),m=-(G.width-20)*C.site-n*C.site;k.css3({transform:"translate3d("+m+"px,0,0)"});clearTimeout(C.search_time);C.move_draw_top=null;C.move_draw_footer=null;C.move_draw_kline=null;C.move_draw_ma=null;C.search_time=setTimeout(function(){C.clearCanvas(C.site);C.move_draw_top=Tool.move_draw_top;C.move_draw_footer=Tool.move_draw_footer;C.move_draw_kline=Tool.move_draw_kline;C.move_draw_ma=Tool.move_draw_ma;C.canvasBox=C.canvas[C.canvasName[C.site]];c.getData(function(q){C.D=q;C.w=C.pic[0].clientWidth;C.h=C.pic[0].clientHeight;$.each(C.canvasName,function(t,s){G.element.canvasBox.canvas[s].elem.css({width:C.w,height:C.h})});var p=b(C.h*0.75),o=b(C.h-p),r;C.canvasWidth=C.w;C.canvasTopHeight=p;C.canvasBottomHeight=o;C.h_line.hide();C.v_line.hide();C.draw_top_border(C.w,p);C.draw_ft_border(C.w,o);C.get_line();r=(C.key=="timePlan");if(r){C.max=cache.p.max;C.min=cache.p.min}else{C.max=cache.dk.max;C.min=cache.dk.min}C.guides(p);C.default_data();C.update_footer()})},300)},clearCanvas:function(m){var l=C.canvas[C.canvasName[m]],k,j=$("");if(!l){return}k=[l.bottom.box||j,l.top.box||j,l.top.ma5||j,l.top.ma10||j,l.top.ma20||j,l.top.av||j];$.each(k,function(o,q){try{var p=q.canvas.width,n=q.canvas.height;q.cr(0,0,p,n)}catch(r){}})},default_data:function(){var k=C.D.display,o=(C.key=="timePlan"),n,j,l,m;n=k.timePlan;n=n[n.length-1];if(o){l=[k.averagePrice,k.Economy,k.time];if(C.type=="i"){l[0]=n[2]}j=[0,1,2]}else{j=k[C.key];j=j[j.length-1];l=[e(k.close),e(k.open),k.time]}m=[k.transactionPrice,k.fluctuation,parseFloat(k.range),k.highPrice,k.lowPrice,k.Volume,l[0],l[1],l[2],j[6],j[7],j[8]];m[0]=parseFloat(k.open)==0?"停牌":m[0];C.update_head(m)},guides:function(l){function j(t,u){t=parseFloat(t);u=parseFloat(u);return e(u+(t-u)/2)}function n(A){var t=A.max,w=A.min,z=e(t),x=A.close||j(t,w),y=j(t,x),v=j(x,w),u=e(w);return[z,y,x,v,u]}function s(t){return n(C.max_min([],0,t.close,t.max,t.min))}C.l_line.height(l);C.r_line.css({height:l+"px",display:"none"});if(C.key!=="timePlan"){var m=s({max:cache.dk.kaimax,min:cache.dk.kaimin});$.each(C.l_line.li,function(t){this.innerHTML=m[t]})}else{var p=s(cache.p),o,r,q,k;C.r_line.css3({display:"box"},true);cache.zf=C.max_min(C.D.display.timePlan,5);r=a(parseFloat(cache.zf.max));q=a(parseFloat(cache.zf.min));k=r>q?r:q;if(r>q){cache.zf.min=-k}else{cache.zf.max=k}o=n(cache.zf);$.each(C.l_line.li,function(t){this.innerHTML=p[t]});$.each(C.r_line.li,function(t){this.innerHTML=a(parseFloat(o[t]))+"%"})}},set_wh:function(k,j,l){var m=b(j/2)+0.5;k.canvas.width=j;k.canvas.height=l;k.cr(0,0,j,l).m(m,0).l(m,l).lw(1).s("#d2d2d2")},draw_top_border:function(n,p){var m=n-0.5,o=p-0.5,k=b(p/2)-0.5,j=p/(Math.ceil(p/80)),q;$.each(C.canvasName,function(s,r){q=C.canvas[r].top.bg;C.set_wh(q,n,p);q.b().m(0.5,0.5).l(m,0.5).l(m,o).l(0.5,o).c().s("#ccc");for(var s=0;s<o;s+=j){if(s!==0&&s!==p){var t=b(s)-0.5;if(t==k){q.b().m(1,t).l(m-1,t).s("#c2c2c2")}else{for(var l=1;l<m-1;l++){if(l%6==0){q.b().m(l,t).l(l+3,t).s("#ccc")}}}}}})},draw_ft_border:function(j,k){var l;$.each(C.canvasName,function(n,m){l=C.canvas[m].bottom.bg;C.set_wh(l,j,k);l.b().m(0.5,0).l(0.5,k-0.5).l(j-0.5,k-0.5).l(j-0.5,0).s("#ccc")})},get_line:function(){var m=C.site,k=m==0?0:1,t=C.canvasWidth,j=C.canvasTopHeight,v=C.canvasBottomHeight,o=C.canvasBox,l=o.top.box,u=o.top.av,s=o.top.ma5,r=o.top.ma10,q=o.top.ma20,p=o.bottom.box;C.key=["timePlan","dailyK","weekK","monthK"][m];C.set_wh(l,t,j);C.set_wh(p,t,v);if(k==0){C.set_wh(u,t,j)}else{C.set_wh(s,t,j);C.set_wh(r,t,j);C.set_wh(q,t,j)}C[["share","Kline"][k]]()},scale:function(k){var j=C.canvasTopHeight-15;return j-C.getScale(k,C.min,C.max,j-15)},get_ft_h:function(k,j){return k/j*(C.canvasBottomHeight-5)},sort:function(l,o,k){var m=l.slice(0);function j(r,p){if(typeof r=="string"){r=parseFloat(r)}if(typeof p=="string"){p=parseFloat(p)}var q=parseFloat(r[o]?r[o]:r),n=parseFloat(p[o]?p[o]:p);if(k){return q-n}return n-q}return m.sort(j)},getScale:function(k,l,j,m){return(k-l)/(j-l)*m},max_min:function(j,k,v,q,m){var s=[],p=j.length,r,o,u,t,l=(C.w-2)/C.line_w;if(j.length){r=C.sort(j,k);q=q||r[0][k];m=m||r[p-1][k]}if(v!=void 0){v=parseFloat(v);u=q-v;t=m-v;o=u+t;if(a(u)>a(t)&&q>v){m-=o}else{q-=o}}return{arr:j,n:k,len:p,lw:l,max:q,min:m,close:v}},share:function(){var l=C.D,j=l.display,k=j.timePlan;C.line_w=242;cache.p=C.max_min(k,1,j.close);if(C.type=="i"){cache.p.max=j.highPrice;cache.p.min=j.lowPrice}C.max=cache.p.max;C.min=cache.p.min;cache.av=C.max_min(k,2,j.close,C.max,C.min);C.draw_line(C.canvasBox.top.box,cache.p,"#005dd8");if(C.type!="i"){clearTimeout(Tool.draw_line_av_time);Tool.draw_line_av_time=setTimeout(function(){C.draw_line(C.canvasBox.top.av,cache.av,"#f79d00")},800)}clearTimeout(Tool.draw_ftline_time);Tool.draw_ftline_time=setTimeout(function(){C.draw_ftline(C.max_min(k,4))},1000)},draw_line:function(m,o,k){var l=0,j=C.max_min([],0,o.close,o.max,o.min);C.close=j.close;C.max=j.max;C.min=j.min;try{C.move_draw_top(o,m,k,l)}catch(n){}},draw_ftline:function(n,k,o){var l=C.canvasBox.bottom.box,j=0;C.set_wh(l,C.canvasWidth,C.canvasBottomHeight);try{C.move_draw_footer(n,l,k,o,j)}catch(m){}},down:function(j){j=T.getEvent(j,0,1);if(this.setCapture){this.setCapture()}C.ismove=true;this.move=false;this.x=j.clientX;this.y=j.clientY;C.h_line.show();C.v_line.show();C.update(j.clientX)},move:function(l){var k=l.touches?l.touches[0]:l;if(C.ismove){if(!this.move){var j=a(k.clientX-this.x),m=a(k.clientY-this.y);if(j>m){this.move=true}}if(this.move==true){T.getEvent(l);C.update(k.clientX)}}},up:function(){this.move=false;C.ismove=false;if(this.releaseCapture){this.releaseCapture()}C.h_line.hide();C.v_line.hide();C.default_data()},update:function(z){var A=C.w-3.5,j=C.D.display[C.key],k,u,p=2.5,B=2.5,r=j.length,v=z-C.marginLeft,m=A/C.line_w,q,s,o=(C.key=="timePlan"),y=0;k=f(v*C.line_w/A);y=o?0:cache.dk.w/2;if(!j[k]){k=k<=0?0:r-1}p=d(k*m+p+y);u=j[k];B=C.scale(u[1])-B;if(o){q={l:j[k][1],r:j[k][5],time:j[k][0]};s=[u[1],u[6],u[5],e(cache.p.max),e(cache.p.min),u[4],u[2],u[3],u[0]]}else{s=[u[1],u[10],parseFloat(u[9]),u[3],u[4],u[5],e(u[2]),u[1],String(u[0]).slice(2),u[6],u[7],u[8]];q={l:j[k][1],r:null,time:j[k][0]}}C.move_line(p,B,q);C.update_head(s)},move_line:function(k,m,o){var j=o.r?38:70,n=k-j/2;C.h_line.line.css({top:m+"px"});C.h_line.lnum.css({top:(m-7)+"px"});C.h_line.rnum.css({top:(m-7)+"px"});C.h_line.lnum.text(o.l);C.h_line.rnum.css({display:(o.r?"block":"none")});if(void 0!=o.r){C.h_line.rnum.text(o.r+"%")}n=n<=0?0:n>=C.w-j?C.w-j:n;C.v_line.line.css({left:k+"px"});C.v_line.num.css({left:n+"px",width:j+"px"});C.v_line.num.text(o.time)},update_head:function(j){var m=[],l,k,n,o=(C.key=="timePlan");if(o){m=["均价","换手"]}else{m=C.ismove?["收盘","开盘"]:["昨收","今开"];var p=["MA5","MA10","MA20"];$.each(C.MA,function(q){this.innerHTML=p[q]+":"+[j[9],j[10],j[11]][q]})}$.each(C.head,function(r){if(r==0){var u=e(j[0]),t=j[1],s=j[2],q;if(t<0){q="green>"}else{if(t>0){q="red>"}else{q=">"}}this.innerHTML="<h3 class="+q+u+"</h3><p class="+q+(t>0?"▲":t<0?"▼":"")+t+" "+s+"%</p>"}else{if(r==1){k=j[5];if(String(k).length>5){k=e(parseFloat(k/10000),2)+"万"}if(String(k).length>6){k=e(parseFloat(k),1)+"万"}if(C.type=="i"&&!o){if(parseFloat(k)>10000){k=e(parseFloat(k)/10000,2)+"亿万"}}this.innerHTML='<p>最高：<span class="red">'+e(j[3])+'</p><p></span>最低：<span class="green">'+e(j[4])+"</p><p></span>成交：<span>"+k+"手<span></p>"}else{n=e(j[7]);if(C.type=="i"&&o){n="--"}this.innerHTML="<p>"+m[0]+"：<span>"+e(j[6])+"</p><p></span>"+m[1]+"：<span>"+n+"</p><p></span>时间：<span>"+j[8]+"<span></p>"}}})},update_footer:function(j){if(C.key=="timePlan"){$.each(C.footer_time,function(l){this.innerHTML=["09:30","11:30/13:00","15:00"][l]})}else{var k=cache.dk;$.each(C.footer_time,function(l){this.innerHTML=[k.from_time,"",k.to_time][l]})}},drawMa:function(o,p){var k=o.arr,l,t=o.len,r=[],v,s=0,m=[C.yellow,C.purple,C.blue][p],q=C.canvasBox.top[["ma5","ma10","ma20"][p]];for(var n=0;n<t;n++){v=parseFloat(k[n][o.n]);if(v!=0){if(!cache.dk.from_time){cache.dk.from_time=k[n][0]}r.push(v);if(n==(t-1)){cache.dk.to_time=k[n][0]}}}var w=C.sort(r);t=r.length;l=(C.w-2)/t;try{C.move_draw_ma(o,q,r,l,s,m)}catch(u){}},Kline:function(){var j=C.D,o=j.display,u=o[C.key],s=C.max_min(u,3).max,m=C.max_min(u,4).min,n=C.max_min(u,1),t=u.length,p=(C.w-2)/t,v=C.canvasBox.top,l=v.box,r=v.ma5,k=v.ma10,w=v.ma20,q=C.canvasBox.bottom.box;C.line_w=t;cache.dk={max:s,min:m,kaimax:n.max,kaimin:n.min,arr:u,len:t,lw:p,w:d(p*0.6),from_time:null,to_time:null};C.max=s;C.min=m;$.each(["dMA5","dMA10","dMA20"],function(y,x){cache[x]=C.max_min(u,y+6);clearTimeout(Tool["ma"+x+"_time"]);Tool["ma"+x+"_time"]=setTimeout(function(){C.drawMa(cache[x],y)},y*500);C.MA.eq(y).css({color:[C.yellow,C.purple,C.blue][y]})});clearTimeout(Tool.draw_ftline_kline_time);Tool.draw_ftline_kline_time=setTimeout(function(){C.draw_ftline(C.max_min(u,5),p*0.5,9)},1000);C.draw_kline(l,cache.dk)},draw_kline:function(k,m){var j=0;try{C.move_draw_kline(m,k,j)}catch(l){}}};return G});